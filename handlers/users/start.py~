# handlers/users/start.py - TO'LIQ XATOSIZ VERSIYA
import asyncio
import logging
import re
from datetime import datetime
from datetime import datetime
import pytz
from aiogram import types
from aiogram.dispatcher import FSMContext
from aiogram.dispatcher.filters.state import State, StatesGroup
from aiogram.utils.exceptions import MessageNotModified

from handlers.users.payment import PaymentState
from loader import dp, bot
from keyboards.default.knopkalar import (
    main_menu, create_keyboard,
    parts_choice_kb, create_parts_inline_kb,
    balance_menu_kb, admin_kb, phone_request_kb, back_kb
)
from keyboards.inline.payment_keyboards import (
    create_tariffs_inline_keyboard,
    create_payment_inline_keyboard
)
from data.config import ADMINS
from utils.api import api
from utils.db_api.database import get_models, get_storages, get_colors, get_batteries, get_price
from utils.db_api.user_database import (
    check_can_price,
    update_phone_number,
    create_user,
    get_user_balance,
    get_user
)

from datetime import datetime
from zoneinfo import ZoneInfo


def uz_now():
    return datetime.now(ZoneInfo("Asia/Tashkent")).strftime("%d.%m.%Y %H:%M")

# ================ LOGGER ================
logger = logging.getLogger(__name__)

# ================ KONSTANTALAR ================

PARTS = {
    'battery': 'Batareyka',
    'back_cover': 'Krishka',
    'face_id': 'Face ID',
    'glass': 'Oyna',
    'screen': 'Ekran',
    'camera': 'Kamera',
    'broken': 'Qirilgan',
    'body': 'Korpus',
}

TELEGRAM_CHANNEL = "https://t.me/sebtech1"
INSTAGRAM_LINK = "https://www.instagram.com/sebtech.uz"
CALLCENTER_1 = "+998 77 285 99 99"
CALLCENTER_2 = "+998 91 285 99 99"

ABOUT_TEXT = f"""âœ¨ <b>SEPTECH</b>

<i>Bozorni his qiladigan narx. Qarorni oson qiladigan standart.</i>

ğŸ“Œ <b>SEPTECH Narxlash Boti</b> â€” <b>Xurshed Tilloyev</b> tashabbusi bilan yaratilgan premium tizim.
Real savdo tajribasi + bozor tahlillari asosida ishlaydi.

<b>Nima beradi?</b>
â€¢ real bozor qiymati (model / xotira / holat bo'yicha)
â€¢ adolatli, tushunarli standart
â€¢ <b>inson aralashuvisiz</b> â€” faqat algoritm

ğŸ” <b>Eslatma:</b> narx bozor bilan birga o'zgaradi, algoritm esa barcha uchun bir xil.

<b>Qadriyatlar:</b> Shaffoflik â€¢ Aniqlik â€¢ Ishonch

ğŸ“£ <b>Rasmiy sahifalar:</b>
â€¢ Telegram: <a href="{TELEGRAM_CHANNEL}">Kanalga o'tish</a>
â€¢ Instagram: <a href="{INSTAGRAM_LINK}">Sahifani ko'rish</a>

ğŸ“ <b>Call-center:</b>
â€¢ {CALLCENTER_1}
â€¢ {CALLCENTER_2}

<i>SEPTECH â€” telefon narxining yangi standarti.</i>
"""


# ================ HOLATLAR ================

class UserState(StatesGroup):
    waiting_phone = State()
    waiting_model = State()
    waiting_storage = State()
    waiting_color = State()
    waiting_battery = State()
    waiting_sim = State()
    waiting_box = State()
    waiting_parts_choice = State()
    waiting_parts = State()


# ================ YORDAMCHI FUNKSIYALAR ================

def should_ask_sim_type(model_name: str) -> bool:
    """iPhone 14 va undan yangi modellar uchun SIM turini so'rash"""
    if not model_name:
        return False

    model_lower = model_name.lower()
    match = re.search(r'iphone\s+(\d+)', model_lower)

    if match:
        iphone_number = int(match.group(1))
        return iphone_number >= 14

    return False


def calculate_final_price(data: dict) -> str:
    """Yakuniy narxni hisoblash"""
    try:
        model_id = data.get('model_id')
        storage = data.get('storage', '')
        color = data.get('color', '')
        sim_type = data.get('sim_type', 'physical')
        battery = data.get('battery', '100%')
        has_box = data.get('has_box', 'Yo\'q')
        selected_parts = data.get('selected_parts', [])

        if not selected_parts:
            damage = "Yangi"
        else:
            damage = "+".join(sorted(selected_parts))

        price = get_price(
            model_id=model_id,
            storage=storage,
            color=color,
            sim_type=sim_type,
            battery=battery,
            has_box=has_box,
            damage=damage
        )

        if price is not None:
            if isinstance(price, (int, float)):
                return f"{price:,.0f} $".replace(",", " ")
            return str(price)

        base_price = get_price(
            model_id=model_id,
            storage=storage,
            color=color,
            sim_type=sim_type,
            battery=battery,
            has_box=has_box,
            damage="Yangi"
        )

        if base_price is not None and isinstance(base_price, (int, float)):
            part_discounts = {
                'battery': 0.02, 'back_cover': 0.03, 'face_id': 0.05,
                'glass': 0.04, 'screen': 0.08, 'camera': 0.05,
                'broken': 0.10, 'body': 0.06,
            }

            total_discount = sum(part_discounts.get(part, 0) for part in selected_parts)
            total_discount = min(total_discount, 0.25)

            final_price = base_price * (1 - total_discount)
            return f"{final_price:,.0f} $".replace(",", " ")

        return "Narx topilmadi"

    except Exception as e:
        logger.error(f"Narx hisoblashda xato: {e}", exc_info=True)
        return "Hisoblash xatosi"


def sort_models_naturally(models):
    """Modellarni tartibga solish"""

    def extract_model_info(name):
        name_lower = name.lower()
        if 'xs max' in name_lower:
            return (10.5, 2)
        elif 'xs' in name_lower:
            return (10.5, 1)
        elif 'xr' in name_lower:
            return (10.3, 0)
        elif name_lower.endswith(' x'):
            return (10, 0)

        match = re.search(r'iphone\s+(\d+)', name_lower)
        if match:
            number = int(match.group(1))
            if 'pro max' in name_lower:
                priority = 3
            elif 'plus' in name_lower:
                priority = 3
            elif 'pro' in name_lower:
                priority = 2
            elif 'mini' in name_lower:
                priority = 1
            else:
                priority = 0
            return (number, priority)
        return (0, 0)

    return sorted(models, key=lambda x: extract_model_info(x['name']), reverse=True)


def sort_storages_naturally(storages):
    """Xotiralarni tartibga solish"""

    def extract_size(size_str):
        match = re.search(r'(\d+)', size_str)
        return int(match.group(1)) if match else 0

    return sorted(storages, key=lambda x: extract_size(x['size']), reverse=True)


def sort_batteries_naturally(batteries):
    """Batareyalarni tartibga solish"""

    def extract_battery_percent(label):
        match = re.search(r'(\d+)', label)
        return int(match.group(1)) if match else 0

    return sorted(batteries, key=lambda x: extract_battery_percent(x['label']), reverse=True)


def html_to_plain(html: str) -> str:
    """HTML taglarni olib tashlab, typing uchun oddiy tekst qaytaradi"""
    HTML_TAG_RE = re.compile(r"<[^>]+>")
    text = re.sub(HTML_TAG_RE, "", html)
    text = text.replace("&nbsp;", " ")
    return text


async def safe_edit(sent, text: str, parse_mode=None):
    """Xavfsiz edit - MessageNotModified xatosini oldini olish"""
    current_text = getattr(sent, "html_text", None) or getattr(sent, "text", None) or ""
    if current_text == text:
        return
    try:
        await sent.edit_text(text, parse_mode=parse_mode)
    except MessageNotModified:
        pass


async def typewriter_two_speed_plain_then_html(
        message,
        html_text: str,
        fast_until_plain: str = "Bozorni his qiladigan narx. Qarorni oson qiladigan standart.",
        fast_delay: float = 0.01,
        slow_delay: float = 0.05,
        fast_chunk: int = 16,
        slow_chunk: int = 10,
):
    """Typing effect bilan xabar yuborish"""
    plain = html_to_plain(html_text)

    idx = plain.find(fast_until_plain)
    fast_end = idx + len(fast_until_plain) if idx != -1 else min(90, len(plain))

    start_len = min(fast_end, len(plain))
    sent = await message.answer(plain[:start_len])

    fast_limit = min(start_len + 120, len(plain))
    for i in range(start_len, fast_limit, fast_chunk):
        await safe_edit(sent, plain[:i + fast_chunk])
        await asyncio.sleep(fast_delay)

    for i in range(fast_limit, len(plain), slow_chunk):
        await safe_edit(sent, plain[:i + slow_chunk])
        await asyncio.sleep(slow_delay)

    await safe_edit(sent, html_text, parse_mode="HTML")
    return sent


async def auto_check_payment(order_id: str, user_id: int, state: FSMContext):
    """Avtomatik to'lov tekshirish"""
    try:
        logger.info(f"Auto check payment started: order_id={order_id}, user={user_id}")
        await asyncio.sleep(10)

        current_state = await state.get_state()
        if current_state != PaymentState.waiting_check.state:
            logger.info(f"State changed, stopping auto check: order_id={order_id}")
            return

        result = await api.check_payment_status(order_id)

        if result.get('success') and result.get('has_payment'):
            if result.get('state') == 2:
                logger.info(f"Payment completed: order_id={order_id}, user={user_id}")

                text = f"""âœ… <b>TO'LOV MUVAFFAQIYATLI!</b>

ğŸ’° <b>Balans:</b> {result.get('balance', 0)} ta narxlash
ğŸ“¦ <b>Qo'shildi:</b> {result.get('count', 0)} ta
ğŸ’µ <b>Summa:</b> {result.get('amount', 0):,.0f} so'm

ğŸ‰ Endi siz telefonlarni narxlashingiz mumkin!
"""
                await bot.send_message(chat_id=user_id, text=text, parse_mode="HTML")
                await state.finish()

    except Exception as e:
        logger.error(f"Auto check payment error: order_id={order_id}, error={e}", exc_info=True)


# ================ START VA ASOSIY HANDLERLAR ================

@dp.message_handler(commands=['start'], state='*')
async def start(message: types.Message, state: FSMContext):
    """Start komandasi - API bilan user yaratish"""
    await state.finish()

    user = message.from_user
    logger.info(f"ğŸ‘¤ User started bot: {user.id} - {user.full_name}")

    # âœ… 1. USER YARATISH (BACKEND API ORQALI)
    try:
        result = await api.create_user(
            telegram_id=user.id,
            full_name=user.full_name or f"User{user.id}",
            username=user.username or ""
        )

        if not result.get('success'):
            logger.error(f"âŒ User creation failed: {result.get('error')}")
            await message.answer(
                "âŒ Xatolik yuz berdi. Iltimos, qaytadan /start bosing.",
                parse_mode="HTML"
            )
            return

        # âœ… BACKEND'DAN PHONE VA BALANS OLISH
        phone_number = result.get('phone')  # âœ… TO'G'RI: 'phone' (phone_number emas!)
        balance = result.get('balance', 0)

        logger.info(f"âœ… User created/updated: {user.id}, phone: {phone_number}, balance: {balance}")

    except Exception as e:
        logger.error(f"âŒ API error on start: {e}", exc_info=True)
        await message.answer(
            "âŒ Serverga ulanishda xatolik. Iltimos, keyinroq /start bosing.",
            parse_mode="HTML"
        )
        return

    # âœ… 2. LOCAL DB'DA HAM USER YARATISH/YANGILASH (5 ta bepul urinish bilan)
    try:
        from utils.db_api.user_database import create_user as create_local_user, get_user_balance as get_local_balance

        # Local DB'da user yaratish yoki yangilash
        local_result = create_local_user(
            telegram_id=user.id,
            full_name=user.full_name or f"User{user.id}",
            username=user.username or "",
            phone_number=phone_number  # Backend'dan olingan telefon
        )

        if local_result.get('success'):
            # Local DB'dan bepul urinishlarni olish
            local_data = get_local_balance(user.id)
            free_trials = local_data.get('free_trials_left', 5)

            if local_result.get('is_new'):
                logger.info(f"ğŸ Yangi user local DB'da yaratildi: {user.id}, free_trials: {free_trials}")
            else:
                logger.info(f"â™»ï¸ User local DB'da yangilandi: {user.id}, free_trials: {free_trials}")
        else:
            logger.warning(f"âš ï¸ Local DB user creation failed: {local_result.get('error')}")
            free_trials = 5

    except Exception as e:
        logger.warning(f"âš ï¸ Local DB error: {e}")
        free_trials = 5

    # âœ… 3. TELEFON RAQAM TEKSHIRISH
    if not phone_number:
        # Telefon so'rash
        text = f"""ğŸ‘‹ Assalomu alaykum, <b>{user.full_name}</b>!

ğŸ“± <b>iPhone narxlash botiga xush kelibsiz!</b>

ğŸ <b>Bepul urinishlar:</b> {free_trials} ta
ğŸ’° <b>Balans:</b> {balance} ta narxlash

â¬‡ï¸ <b>Davom etish uchun telefon raqamingizni yuboring:</b>"""

        await UserState.waiting_phone.set()
        await message.answer(text, reply_markup=phone_request_kb(), parse_mode="HTML")
        return

    # âœ… 4. ASOSIY MENYU (TELEFON BOR BO'LSA)
    text = f"""ğŸ‘‹ Assalomu alaykum, <b>{user.full_name}</b>!

ğŸ“± <b>iPhone narxlash botiga xush kelibsiz!</b>

ğŸ <b>Bepul urinishlar:</b> {free_trials} ta
ğŸ’° <b>Balans:</b> {balance} ta narxlash

<b>â¬‡ï¸ Quyidagi menyulardan birini tanlang:</b>"""

    await message.answer(
        text,
        reply_markup=main_menu(user.id in ADMINS),
        parse_mode="HTML"
    )


@dp.message_handler(content_types=['contact'], state=UserState.waiting_phone)
async def receive_phone(message: types.Message, state: FSMContext):
    """Telefon raqamini qabul qilish - FAQAT contact orqali"""

    # âœ… 1. TEKSHIRISH
    if message.contact.user_id != message.from_user.id:
        await message.answer(
            "âŒ Iltimos, O'Z telefon raqamingizni yuboring!\n\nğŸ“± Quyidagi tugmani bosing:",
            reply_markup=phone_request_kb(),
            parse_mode="HTML"
        )
        return

    phone_number = message.contact.phone_number
    if not phone_number.startswith('+'):
        phone_number = '+' + phone_number

    # âœ… 2. BACKEND API'GA TELEFON YUBORISH
    try:
        result = await api.update_phone(message.from_user.id, phone_number)

        if not result.get('success'):
            logger.error(f"âŒ Backend phone update failed: {result.get('error')}")
            await message.answer(
                "âŒ Telefon raqamini saqlashda xatolik. Qaytadan /start bosing.",
                parse_mode="HTML"
            )
            await state.finish()
            return

        logger.info(f"âœ… Phone updated in backend: {message.from_user.id} -> {phone_number}")

    except Exception as e:
        logger.error(f"âŒ Backend phone update error: {e}")
        await message.answer(
            "âŒ Serverga ulanishda xatolik. Qaytadan /start bosing.",
            parse_mode="HTML"
        )
        await state.finish()
        return

    # âœ… 3. LOCAL DB'GA HAM SAQLASH (sinxronizatsiya uchun)
    try:
        from utils.db_api.user_database import update_phone_number
        update_phone_number(message.from_user.id, phone_number)
        logger.info(f"âœ… Phone also saved in local DB: {message.from_user.id}")
    except Exception as e:
        logger.warning(f"âš ï¸ Local DB phone update error: {e}")
        # Backend'da saqlanganligini bildik, davom ettiramiz

    # âœ… 4. BALANS OLISH (Backend API'dan)
    try:
        balance_result = await api.get_balance(message.from_user.id)
        balance = balance_result.get('balance', 0)
    except Exception as e:
        logger.error(f"âŒ Balance fetch error: {e}")
        balance = 0

    # âœ… 5. BEPUL URINISHLAR (Local DB'dan)
    try:
        from utils.db_api.user_database import get_user_balance as get_local_balance
        local_data = get_local_balance(message.from_user.id)
        free_trials = local_data.get('free_trials_left', 5)
    except Exception as e:
        logger.warning(f"âš ï¸ Local DB error: {e}")
        free_trials = 5

    # âœ… 6. MODELLAR SONINI OLISH
    try:
        from utils.db_api.database import get_models
        models = get_models()
        models_text = f"âœ… <b>{len(models)}</b> ta model mavjud\n"
    except Exception as e:
        logger.warning(f"âš ï¸ Models fetch error: {e}")
        models_text = ""

    # âœ… 7. MUVAFFAQIYATLI XABAR
    text = f"""âœ… <b>Telefon raqami qabul qilindi!</b>

ğŸ“ <b>Raqam:</b> {phone_number}

ğŸ <b>Bepul urinishlar:</b> {free_trials} ta
ğŸ’° <b>Balans:</b> {balance} ta narxlash
{models_text}
<b>â¬‡ï¸ Quyidagi menyulardan birini tanlang:</b>
"""

    await state.finish()
    await message.answer(text, reply_markup=main_menu(message.from_user.id in ADMINS), parse_mode="HTML")


@dp.message_handler(state=UserState.waiting_phone)
async def phone_state_handler(message: types.Message, state: FSMContext):
    """Telefon raqami kutilayotgan holatda"""
    if message.text in ["â—€ï¸ Orqaga", "ğŸ  Bosh menyu"]:
        await state.finish()
        await message.answer("ğŸ  Bosh menyu", reply_markup=main_menu(message.from_user.id in ADMINS))
        return

    await message.answer(
        "ğŸ“± Iltimos, <b>Telefon raqamni yuborish</b> tugmasini bosing!",
        reply_markup=phone_request_kb(),
        parse_mode="HTML"
    )


# ================ ADMIN PANEL ================

@dp.message_handler(lambda m: m.text == "ğŸ”§ Admin panel" and m.from_user.id in ADMINS, state='*')
async def admin_panel_handler(message: types.Message, state: FSMContext):
    """Admin panel"""
    await state.finish()

    from utils.db_api.database import get_total_prices_count

    models_count = len(get_models())
    prices_count = get_total_prices_count()

    tariffs_result = await api.get_tariffs()
    tariffs_count = len(tariffs_result.get('tariffs', [])) if tariffs_result.get('success') else 0

    text = f"""<b>ğŸ‘¨â€ğŸ’¼ ADMIN PANEL</b>

ğŸ“Š <b>Statistika:</b>
- ğŸ“± Modellar: {models_count} ta
- ğŸ’° Narxlar: {prices_count} ta
- ğŸ’³ Tariflar: {tariffs_count} ta
- ğŸ‘¥ Adminlar: {len(ADMINS)} ta

<b>ğŸ”§ Mavjud amallar:</b>
1. ğŸ“Š Statistika - To'liq statistika
2. ğŸ’³ Tariflar - Tariflarni ko'rish
3. ğŸ“¥ Excel import - Faylni yuklash
4. ğŸ“¤ Excel export - Bazani export qilish
5. ğŸ§¹ Tozalash - Test ma'lumotlarni o'chirish
6. ğŸ“± Namuna - Model uchun narxlar

<b>âš ï¸ Diqqat:</b> Import dan oldin backup oling!
"""
    await message.answer(text, reply_markup=admin_kb(), parse_mode="HTML")


@dp.message_handler(lambda m: m.text == "ğŸ‘¤ Mening hisobim", state='*')
async def my_account(message: types.Message, state: FSMContext):
    """Mening hisobim"""
    await state.finish()

    result = get_user_balance(message.from_user.id)

    if not result.get('success'):
        await message.answer("âŒ Xatolik yuz berdi")
        return

    balance = result.get('balance', 0)
    free_trials = result.get('free_trials_left', 0)
    full_name = result.get('full_name', message.from_user.full_name)
    phone_number = result.get('phone_number', 'Kiritilmagan')
    total_pricings = result.get('total_pricings', 0)

    text = f"""ğŸ‘¤ <b>Shaxsiy kabinet</b>

ğŸ“ <b>Ism:</b> {full_name}
ğŸ“± <b>Telefon:</b> {phone_number}
ğŸ†” <b>ID:</b> <code>{message.from_user.id}</code>
ğŸ’° <b>Balans:</b> {balance} ta narxlash
ğŸ <b>Bepul urinishlar:</b> {free_trials} ta
ğŸ“Š <b>Jami narxlashlar:</b> {total_pricings} ta

"""

    if balance > 0:
        text += f"âœ… Siz {balance} marta telefon narxlashingiz mumkin."
    elif free_trials > 0:
        text += f"ğŸ Sizda {free_trials} ta bepul urinish mavjud!"
    else:
        text += (
            "âš ï¸ Balans yetarli emas!\n"
            "ğŸ’³ Hisobni to'ldirish uchun <b>'ğŸ’° Hisobni to'ldirish'</b> tugmasini bosing."
        )

    await message.answer(text, reply_markup=balance_menu_kb(), parse_mode="HTML")


@dp.message_handler(lambda m: m.text in ["â—€ï¸ Orqaga", "ğŸ  Bosh menyu"], state="*")
async def back_to_menu(message: types.Message, state: FSMContext):
    """Bosh menyuga qaytish"""
    await state.finish()
    await message.answer("ğŸ  Bosh menyu", reply_markup=main_menu(message.from_user.id in ADMINS))


# ================ TO'LOV HANDLERLAR ================

@dp.message_handler(lambda m: m.text == "ğŸ’° Hisobni to'ldirish", state='*')
async def start_payment(message: types.Message, state: FSMContext):
    """Hisobni to'ldirish"""
    result = await api.get_tariffs()

    if not result.get('success'):
        await message.answer("âŒ Tariflar yuklanmadi. Iltimos, keyinroq urinib ko'ring.")
        return

    tariffs = result.get('tariffs', [])

    if not tariffs:
        await message.answer("ğŸ“‹ Hozircha tariflar mavjud emas.")
        return

    markup = create_tariffs_inline_keyboard(tariffs)

    text = "ğŸ’° <b>Hisobni to'ldirish</b>\n\n"
    text += "Quyidagi tariflardan birini tanlang:\n\n"

    for tariff in tariffs:
        price_per_one = tariff['price'] / tariff['count']
        emoji = '1ï¸âƒ£' if tariff['count'] == 1 else '5ï¸âƒ£' if tariff['count'] == 5 else 'ğŸ”Ÿ'
        text += f"{emoji} <b>{tariff['name']}</b>\n"
        text += f"   Narx: {tariff['price']:,.0f} so'm\n"
        text += f"   Bitta: {price_per_one:,.0f} so'm\n\n"

    text += "ğŸ‘‡ Tarifni tanlang:"

    await PaymentState.waiting_tariff.set()
    await message.answer(text, reply_markup=markup, parse_mode="HTML")


@dp.callback_query_handler(lambda c: c.data and c.data.startswith("tariff_"), state=PaymentState.waiting_tariff)
async def process_tariff(callback: types.CallbackQuery, state: FSMContext):
    """Tarif tanlandi"""
    await callback.answer()

    try:
        tariff_id = int(callback.data.split("_")[1])
    except:
        await callback.answer("âŒ Xato tarif", show_alert=True)
        return

    result = await api.create_payment(
        telegram_id=callback.from_user.id,
        tariff_id=tariff_id
    )

    if not result.get('success'):
        error_msg = result.get('error', 'Xatolik yuz berdi')
        await callback.answer(f"âŒ {error_msg}", show_alert=True)
        return

    order_id = result.get('order_id', '')

    if not order_id:
        logger.error(f"Order ID not received for user {callback.from_user.id}")
        await callback.answer("âŒ Order ID mavjud emas", show_alert=True)
        return

    await state.update_data(
        order_id=order_id,
        payment_id=result.get('payment_id'),
        payment_url=result.get('payment_url'),
        amount=result.get('amount'),
        count=result.get('count'),
        tariff_name=result.get('tariff_name')
    )

    text = f"""ğŸ’³ <b>To'lov ma'lumotlari</b>

ğŸ†” <b>Order ID:</b> <code>{order_id}</code>
ğŸ’° <b>Summa:</b> {result.get('amount', 0):,.0f} so'm
ğŸ“¦ <b>Narxlashlar:</b> {result.get('count', 0)} ta
ğŸ·ï¸ <b>Tarif:</b> {result.get('tariff_name', '')}

<b>To'lov qilish uchun:</b>
1ï¸âƒ£ Quyidagi tugma orqali Payme ga o'ting
2ï¸âƒ£ To'lovni amalga oshiring
3ï¸âƒ£ To'lov qilganingizdan so'ng "âœ… To'lov qildim" tugmasini bosing

â³ To'lov 30 daqiqa ichida amalga oshirilishi kerak!
"""

    markup = create_payment_inline_keyboard(result.get('payment_url', ''))

    try:
        await callback.message.delete()
    except:
        pass

    await PaymentState.waiting_check.set()
    await callback.message.answer(text, reply_markup=markup, parse_mode="HTML")

    asyncio.create_task(auto_check_payment(order_id, callback.from_user.id, state))


@dp.callback_query_handler(lambda c: c.data == "check_payment", state=PaymentState.waiting_check)
async def check_payment_handler(callback: types.CallbackQuery, state: FSMContext):
    """To'lovni tekshirish"""
    await callback.answer("ğŸ”„ Tekshirilmoqda...")

    data = await state.get_data()
    order_id = data.get('order_id')

    if not order_id:
        await callback.answer("âŒ Order ID topilmadi.", show_alert=True)
        return

    result = await api.check_payment_status(order_id)

    if not result.get('success'):
        await callback.answer(
            "âŒ To'lov topilmadi. Iltimos, to'lovni amalga oshiring.",
            show_alert=True
        )
        return

    if result.get('has_payment'):
        if result.get('state') == 2:
            text = f"""âœ… <b>TO'LOV MUVAFFAQIYATLI!</b>

ğŸ’° <b>Balans:</b> {result.get('balance', 0)} ta narxlash
ğŸ“¦ <b>Qo'shildi:</b> {result.get('count', 0)} ta
ğŸ’µ <b>Summa:</b> {result.get('amount', 0):,.0f} so'm

ğŸ‰ Endi siz telefonlarni narxlashingiz mumkin!
"""
            try:
                await callback.message.edit_text(text, parse_mode="HTML")
            except:
                await callback.message.answer(text, parse_mode="HTML")

            await state.finish()

        elif result.get('state') == 1:
            await callback.answer(
                "â³ To'lov hali amalga oshirilmadi.\nIltimos, to'lovni amalga oshiring.",
                show_alert=True
            )
        else:
            await callback.answer(
                "âŒ To'lov bekor qilindi.\nIltimos, qaytadan urinib ko'ring.",
                show_alert=True
            )
            await state.finish()
    else:
        await callback.answer(
            "âŒ To'lov topilmadi. Iltimos, to'lovni amalga oshiring.",
            show_alert=True
        )


@dp.callback_query_handler(lambda c: c.data == "cancel_payment", state=PaymentState.waiting_check)
async def cancel_payment_callback(callback: types.CallbackQuery, state: FSMContext):
    """To'lovni bekor qilish"""
    try:
        await callback.message.delete()
    except:
        pass
    await callback.answer("âŒ To'lov bekor qilindi")
    await state.finish()
    await callback.message.answer("ğŸ  Bosh menyu", reply_markup=main_menu(callback.from_user.id in ADMINS))


# ================ NARXLASH HANDLERLAR ================

@dp.message_handler(lambda m: m.text in ["ğŸ“± Telefon narxlash", "ğŸ”„ Yana hisoblash"], state='*')
async def choose_model(message: types.Message, state: FSMContext):
    """
    âœ… Model tanlash:
    - LOCAL: telefon raqami + free_trials tekshirish
    - API: paid balance tekshirish (faqat free tugagan bo'lsa)
    """
    await state.finish()
    user_id = message.from_user.id

    # 1) LOCAL tekshiruv (telefon raqami + free trial)
    local_check = check_can_price(user_id)

    # user yo'q bo'lsa (localda) - odatda create_user() qilingan bo'lishi kerak
    if not local_check.get("success"):
        await message.answer("âŒ Local bazada user topilmadi. /start bosing.")
        return

    # Telefon raqami kerak bo'lsa
    if local_check.get("need_phone"):
        await message.answer(local_check.get("message", "ğŸ“± Iltimos, telefon raqam kiriting"))
        return

    free_trials = int(local_check.get("free_trials_left", 0) or 0)

    # 2) API balans (faqat free tugagan bo'lsa)
    api_balance = 0
    if free_trials <= 0:
        try:
            api_res = await api.get_balance(user_id)
            api_balance = int(api_res.get("balance", 0) or 0)
        except Exception as e:
            logger.error(f"âŒ API balansini olishda xatolik: {e}")
            api_balance = 0

    # 3) Umumiy tekshiruv
    if free_trials <= 0 and api_balance <= 0:
        text = f"""âŒ <b>Balans yetarli emas!</b>

ğŸ <b>Bepul urinishlar:</b> 0 ta
ğŸ’° <b>Sotib olingan balans:</b> {api_balance} ta

ğŸ’¡ <b>Hisobni to'ldirish uchun quyidagi tugmani bosing:</b>
"""
        from aiogram.types import ReplyKeyboardMarkup, KeyboardButton
        kb = ReplyKeyboardMarkup(resize_keyboard=True)
        kb.row(KeyboardButton("ğŸ’° Hisobni to'ldirish"))
        kb.row(KeyboardButton("ğŸ  Bosh menyu"))
        await message.answer(text, reply_markup=kb, parse_mode="HTML")
        return

    # 4) Modellarni chiqarish
    models = get_models()
    if not models:
        await message.answer("âŒ Modellar topilmadi")
        return

    sorted_models = sort_models_naturally(models)
    kb = create_keyboard([m['name'] for m in sorted_models], row_width=2)

    # 5) Status matni
    if free_trials > 0:
        status_text = f"ğŸ <b>Bepul urinish: {free_trials} ta qoldi</b>"
    else:
        status_text = f"ğŸ’° <b>Balans: {api_balance} ta narxlash</b>"

    text = f"""ğŸ“± <b>Telefon narxlash</b>

{status_text}

<b>Modelni tanlang:</b>
"""
    await UserState.waiting_model.set()
    await message.answer(text, reply_markup=kb, parse_mode="HTML")


@dp.message_handler(state=UserState.waiting_model)
async def model_selected(message: types.Message, state: FSMContext):
    """Model tanlandi"""
    if message.text in ["â—€ï¸ Orqaga", "ğŸ  Bosh menyu"]:
        await state.finish()
        await message.answer("ğŸ  Bosh menyu", reply_markup=main_menu(message.from_user.id in ADMINS))
        return

    models = get_models()
    model = next((m for m in models if m['name'] == message.text), None)

    if not model:
        await message.answer("âŒ Model topilmadi. Iltimos, tugmalardan birini tanlang.")
        return

    await state.update_data(model_id=model['id'], model_name=model['name'])

    storages = get_storages(model['id'])

    if not storages:
        await message.answer("âŒ Xotiralar topilmadi")
        return

    sorted_storages = sort_storages_naturally(storages)
    storage_sizes = [s['size'] for s in sorted_storages]

    kb = create_keyboard(storage_sizes, row_width=2)

    await message.answer("<b>ğŸ’¾ Xotira hajmini tanlang:</b>", reply_markup=kb, parse_mode="HTML")
    await UserState.waiting_storage.set()


@dp.message_handler(state=UserState.waiting_storage)
async def storage_selected(message: types.Message, state: FSMContext):
    """Xotira tanlandi"""
    if message.text in ["â—€ï¸ Orqaga", "ğŸ  Bosh menyu"]:
        if message.text == "ğŸ  Bosh menyu":
            await state.finish()
            await message.answer("ğŸ  Bosh menyu", reply_markup=main_menu(message.from_user.id in ADMINS))
        else:
            models = get_models()
            sorted_models = sort_models_naturally(models)
            model_names = [m['name'] for m in sorted_models]
            kb = create_keyboard(model_names, row_width=2)
            await message.answer("<b>ğŸ“± Modelni tanlang:</b>", reply_markup=kb, parse_mode="HTML")
            await UserState.waiting_model.set()
        return

    await state.update_data(storage=message.text)

    data = await state.get_data()
    colors = get_colors(data['model_id'])

    if colors:
        color_names = [c['name'] for c in colors]
        kb = create_keyboard(color_names, row_width=2)
        await message.answer("<b>ğŸ¨ Rangni tanlang:</b>", reply_markup=kb, parse_mode="HTML")
        await UserState.waiting_color.set()
    else:
        await state.update_data(color="Standart")
        batteries = get_batteries(data['model_id']) or [{"label": "100%"}]
        sorted_batteries = sort_batteries_naturally(batteries)
        battery_labels = [b['label'] for b in sorted_batteries]
        kb = create_keyboard(battery_labels, row_width=2)
        await message.answer("<b>ğŸ”‹ Batareya holatini tanlang:</b>", reply_markup=kb, parse_mode="HTML")
        await UserState.waiting_battery.set()


@dp.message_handler(state=UserState.waiting_color)
async def color_selected(message: types.Message, state: FSMContext):
    """Rang tanlandi"""
    if message.text in ["â—€ï¸ Orqaga", "ğŸ  Bosh menyu"]:
        if message.text == "ğŸ  Bosh menyu":
            await state.finish()
            await message.answer("ğŸ  Bosh menyu", reply_markup=main_menu(message.from_user.id in ADMINS))
        else:
            data = await state.get_data()
            storages = get_storages(data['model_id'])
            sorted_storages = sort_storages_naturally(storages)
            storage_sizes = [s['size'] for s in sorted_storages]
            kb = create_keyboard(storage_sizes, row_width=2)
            await message.answer("<b>ğŸ’¾ Xotira hajmini tanlang:</b>", reply_markup=kb, parse_mode="HTML")
            await UserState.waiting_storage.set()
        return

    await state.update_data(color=message.text)

    data = await state.get_data()
    batteries = get_batteries(data['model_id']) or [{"label": "100%"}]
    sorted_batteries = sort_batteries_naturally(batteries)
    battery_labels = [b['label'] for b in sorted_batteries]

    kb = create_keyboard(battery_labels, row_width=2)

    await message.answer("<b>ğŸ”‹ Batareya holatini tanlang:</b>", reply_markup=kb, parse_mode="HTML")
    await UserState.waiting_battery.set()


@dp.message_handler(state=UserState.waiting_battery)
async def battery_selected(message: types.Message, state: FSMContext):
    """Batareya tanlandi"""
    if message.text in ["â—€ï¸ Orqaga", "ğŸ  Bosh menyu"]:
        if message.text == "ğŸ  Bosh menyu":
            await state.finish()
            await message.answer("ğŸ  Bosh menyu", reply_markup=main_menu(message.from_user.id in ADMINS))
        else:
            data = await state.get_data()
            colors = get_colors(data['model_id'])
            if colors:
                color_names = [c['name'] for c in colors]
                kb = create_keyboard(color_names, row_width=2)
                await message.answer("<b>ğŸ¨ Rangni tanlang:</b>", reply_markup=kb, parse_mode="HTML")
                await UserState.waiting_color.set()
            else:
                storages = get_storages(data['model_id'])
                sorted_storages = sort_storages_naturally(storages)
                storage_sizes = [s['size'] for s in sorted_storages]
                kb = create_keyboard(storage_sizes, row_width=2)
                await message.answer("<b>ğŸ’¾ Xotira hajmini tanlang:</b>", reply_markup=kb, parse_mode="HTML")
                await UserState.waiting_storage.set()
        return

    await state.update_data(battery=message.text)

    data = await state.get_data()
    model_name = data.get('model_name', '')

    if should_ask_sim_type(model_name):
        from aiogram.types import ReplyKeyboardMarkup, KeyboardButton
        kb = ReplyKeyboardMarkup(resize_keyboard=True)
        kb.row(KeyboardButton("ğŸ“± SIM karta"), KeyboardButton("ğŸ“² eSIM"))
        kb.row(KeyboardButton("â—€ï¸ Orqaga"), KeyboardButton("ğŸ  Bosh menyu"))

        await message.answer("<b>ğŸ“ SIM turini tanlang:</b>", reply_markup=kb, parse_mode="HTML")
        await UserState.waiting_sim.set()
    else:
        from aiogram.types import ReplyKeyboardMarkup, KeyboardButton
        kb = ReplyKeyboardMarkup(resize_keyboard=True)
        kb.row(KeyboardButton("âœ… Bor"), KeyboardButton("âŒ Yo'q"))
        kb.row(KeyboardButton("â—€ï¸ Orqaga"), KeyboardButton("ğŸ  Bosh menyu"))

        await message.answer("<b>ğŸ“¦ Quti bor/yo'q:</b>", reply_markup=kb, parse_mode="HTML")
        await UserState.waiting_box.set()
        await state.update_data(sim_type="physical")


@dp.message_handler(state=UserState.waiting_sim)
async def sim_selected(message: types.Message, state: FSMContext):
    """SIM tanlandi"""
    if message.text in ["â—€ï¸ Orqaga", "ğŸ  Bosh menyu"]:
        if message.text == "ğŸ  Bosh menyu":
            await state.finish()
            await message.answer("ğŸ  Bosh menyu", reply_markup=main_menu(message.from_user.id in ADMINS))
        else:
            data = await state.get_data()
            batteries = get_batteries(data['model_id']) or [{"label": "100%"}]
            sorted_batteries = sort_batteries_naturally(batteries)
            battery_labels = [b['label'] for b in sorted_batteries]
            kb = create_keyboard(battery_labels, row_width=2)
            await message.answer("<b>ğŸ”‹ Batareya holatini tanlang:</b>", reply_markup=kb, parse_mode="HTML")
            await UserState.waiting_battery.set()
        return

    sim_type = "esim" if "eSIM" in message.text else "physical"
    await state.update_data(sim_type=sim_type)

    from aiogram.types import ReplyKeyboardMarkup, KeyboardButton
    kb = ReplyKeyboardMarkup(resize_keyboard=True)
    kb.row(KeyboardButton("âœ… Bor"), KeyboardButton("âŒ Yo'q"))
    kb.row(KeyboardButton("â—€ï¸ Orqaga"), KeyboardButton("ğŸ  Bosh menyu"))

    await message.answer("<b>ğŸ“¦ Quti bor/yo'q:</b>", reply_markup=kb, parse_mode="HTML")
    await UserState.waiting_box.set()


@dp.message_handler(state=UserState.waiting_box)
async def box_selected(message: types.Message, state: FSMContext):
    """Quti tanlandi"""
    if message.text in ["â—€ï¸ Orqaga", "ğŸ  Bosh menyu"]:
        if message.text == "ğŸ  Bosh menyu":
            await state.finish()
            await message.answer("ğŸ  Bosh menyu", reply_markup=main_menu(message.from_user.id in ADMINS))
        else:
            data = await state.get_data()
            model_name = data.get('model_name', '')

            if should_ask_sim_type(model_name):
                from aiogram.types import ReplyKeyboardMarkup, KeyboardButton
                kb = ReplyKeyboardMarkup(resize_keyboard=True)
                kb.row(KeyboardButton("ğŸ“± SIM karta"), KeyboardButton("ğŸ“² eSIM"))
                kb.row(KeyboardButton("â—€ï¸ Orqaga"), KeyboardButton("ğŸ  Bosh menyu"))
                await message.answer("<b>ğŸ“ SIM turini tanlang:</b>", reply_markup=kb, parse_mode="HTML")
                await UserState.waiting_sim.set()
            else:
                batteries = get_batteries(data['model_id']) or [{"label": "100%"}]
                sorted_batteries = sort_batteries_naturally(batteries)
                battery_labels = [b['label'] for b in sorted_batteries]
                kb = create_keyboard(battery_labels, row_width=2)
                await message.answer("<b>ğŸ”‹ Batareya holatini tanlang:</b>", reply_markup=kb, parse_mode="HTML")
                await UserState.waiting_battery.set()
        return

    has_box = "Bor" if "Bor" in message.text else "Yo'q"
    await state.update_data(has_box=has_box)

    await message.answer(
        "<b>ğŸ”§ Telefonning qismlari almashganmi?</b>",
        reply_markup=parts_choice_kb(),
        parse_mode="HTML"
    )
    await UserState.waiting_parts_choice.set()


@dp.message_handler(state=UserState.waiting_parts_choice)
async def parts_choice_selected(message: types.Message, state: FSMContext):
    """Qismlar tanlovi"""
    if message.text in ["â—€ï¸ Orqaga", "ğŸ  Bosh menyu"]:
        if message.text == "ğŸ  Bosh menyu":
            await state.finish()
            await message.answer("ğŸ  Bosh menyu", reply_markup=main_menu(message.from_user.id in ADMINS))
        else:
            from aiogram.types import ReplyKeyboardMarkup, KeyboardButton
            kb = ReplyKeyboardMarkup(resize_keyboard=True)
            kb.row(KeyboardButton("âœ… Bor"), KeyboardButton("âŒ Yo'q"))
            kb.row(KeyboardButton("â—€ï¸ Orqaga"), KeyboardButton("ğŸ  Bosh menyu"))
            await message.answer("<b>ğŸ“¦ Quti bor/yo'q:</b>", reply_markup=kb, parse_mode="HTML")
            await UserState.waiting_box.set()
        return

    if message.text == "âŒ Yo'q":
        await state.update_data(selected_parts=[], damage_display="Yangi")
        await show_final_price(message, state)
        return

    if message.text == "âœ… Ha":
        await state.update_data(selected_parts=[])

        markup = create_parts_inline_kb([], PARTS)

        from aiogram.types import ReplyKeyboardMarkup, KeyboardButton
        kb = ReplyKeyboardMarkup(resize_keyboard=True)
        kb.row(KeyboardButton("â—€ï¸ Orqaga"), KeyboardButton("ğŸ  Bosh menyu"))

        await message.answer(
            "<b>ğŸ”§ Almashgan qismlarni tanlang (maks 3 ta):</b>",
            reply_markup=kb,
            parse_mode="HTML"
        )

        await message.answer("â¬‡ï¸ Quyidagi qismlardan tanlang:", reply_markup=markup)

        await UserState.waiting_parts.set()
        return

    await message.answer("âŒ Iltimos, tugmalardan birini tanlang:", reply_markup=parts_choice_kb())


# ================ QISMLAR TANLASH HANDLERI ================

@dp.callback_query_handler(state=UserState.waiting_parts)
async def parts_callback(call: types.CallbackQuery, state: FSMContext):
    """
    Inline callback - Qismlar tanlash
    âœ… TO'LIQ TUZATILGAN VERSIYA
    """
    data = await state.get_data()
    selected = data.get('selected_parts', [])

    # ============= TUGMA BOSILDI =============
    if call.data == "part_done":
        if not selected:
            await call.answer("âŒ Hech narsa tanlanmadi!", show_alert=True)
            return

        # Tanlangan qismlarni saqlash
        damage_display = " + ".join([PARTS[k] for k in sorted(selected)])
        await state.update_data(damage_display=damage_display)

        # Inline xabarni o'chirish
        try:
            await call.message.delete()
        except Exception as e:
            logger.warning(f"Cannot delete inline message: {e}")

        # âœ… TO'G'RI: Callback uchun maxsus funksiya
        await show_final_price_from_callback(call, state)
        await call.answer()
        return

    # ============= QISM TANLANDI/BEKOR QILINDI =============
    part_key = call.data.replace("part_", "")

    # Ekran va Oyna birga bo'lishi mumkin emas
    if part_key in ("screen", "glass"):
        other = "glass" if part_key == "screen" else "screen"
        if other in selected:
            await call.answer("âŒ Ekran va Oyna birga bo'lishi mumkin emas!", show_alert=True)
            return

    # Qo'shish yoki olib tashlash
    if part_key in selected:
        selected.remove(part_key)
    else:
        if len(selected) >= 3:
            await call.answer("âŒ Maksimum 3 ta qism tanlash mumkin!", show_alert=True)
            return
        selected.append(part_key)

    # State ga saqlash
    await state.update_data(selected_parts=selected)

    # Inline keyboard ni yangilash
    markup = create_parts_inline_kb(selected, PARTS)

    # Tanlangan qismlarni ko'rsatish
    selected_names = [PARTS[k] for k in sorted(selected)]
    if selected_names:
        text = f"<b>ğŸ”§ Tanlangan:</b> {', '.join(selected_names)}"
    else:
        text = "<b>ğŸ”§ Almashgan qismlarni tanlang (maks 3 ta):</b>"

    # Xabarni yangilash
    try:
        await call.message.edit_text(text, reply_markup=markup, parse_mode="HTML")
    except MessageNotModified:
        pass  # Agar o'zgarish bo'lmasa
    except Exception as e:
        logger.warning(f"Cannot edit inline message: {e}")

    await call.answer()


# ================ YAKUNIY NARX - CALLBACK DAN ================

async def show_final_price_from_callback(call: types.CallbackQuery, state: FSMContext):
    """
    âœ… Yakuniy narx - CALLBACK
    - free_trial bo'lsa LOCAL dan yechadi
    - free tugasa API paid balansdan yechadi
    """
    from utils.db_api.user_database import check_can_price, use_pricing as use_pricing_local

    data = await state.get_data()
    selected = data.get('selected_parts', [])
    color = data.get('color') or ""

    if 'sim_type' not in data:
        data['sim_type'] = 'physical'

    # Damage display
    if not selected:
        damage_display = "Yangi"
    else:
        damage_display = data.get('damage_display', " + ".join([PARTS[k] for k in sorted(selected)]))

    # Narxni hisoblash
    try:
        final_price = calculate_final_price(data)
    except Exception as e:
        logger.error(f"Price calculation error: {e}", exc_info=True)
        final_price = "Hisoblash jarayonida..."

    phone_model = f"{data['model_name']} {data['storage']}"

    # Narxni raqamga aylantirish
    price_value = 0
    if isinstance(final_price, str):
        price_str = final_price.replace(" $", "").replace("$", "").replace(" ", "").replace(",", "")
        try:
            price_value = int(float(price_str))
        except:
            price_value = 0
    elif isinstance(final_price, (int, float)):
        price_value = int(final_price)

    user_id = call.from_user.id

    # âœ… 1) LOCAL free trial tekshiruv
    local_check = check_can_price(user_id)
    free_trials_left = int(local_check.get("free_trials_left", 0) or 0)

    # DEFAULT qiymatlar
    is_free = False
    balance = 0

    # âœ… 2) Agar free trial bo'lsa -> LOCAL yechamiz
    if free_trials_left > 0:
        local_res = use_pricing_local(
            telegram_id=user_id,
            phone_model=phone_model,
            storage=data.get('storage', ''),
            color=color,
            battery=data.get('battery', '100%'),
            sim_type=data.get('sim_type', 'physical'),
            has_box=data.get('has_box', "Yo'q"),
            damage=damage_display,
            price=price_value
        )

        if not local_res.get("success"):
            await call.message.answer(
                f"âŒ {local_res.get('error', 'Xatolik')}",
                reply_markup=main_menu(user_id in ADMINS)
            )
            await state.finish()
            return

        is_free = True
        free_trials_left = int(local_res.get("free_trials_left", 0) or 0)

        # API balansni ko'rsatish uchun (ixtiyoriy)
        try:
            api_res = await api.get_balance(user_id)
            balance = int(api_res.get("balance", 0) or 0)
        except Exception as e:
            logger.error(f"API balance get error: {e}")
            balance = 0

    # âœ… 3) Free tugagan -> API paid balansdan yechamiz
    else:
        try:
            api_res = await api.use_pricing(
                telegram_id=user_id,
                phone_model=phone_model,
                price=price_value
            )
        except Exception as e:
            logger.error(f"API use_pricing error: {e}", exc_info=True)
            await call.message.answer(
                "âŒ Server bilan bog'lanishda xatolik (API). Keyinroq urinib ko'ring.",
                reply_markup=main_menu(user_id in ADMINS)
            )
            await state.finish()
            return

        if not api_res.get("success"):
            await call.message.answer(
                f"âŒ {api_res.get('error', 'Balans yetarli emas')}",
                reply_markup=main_menu(user_id in ADMINS)
            )
            await state.finish()
            return

        is_free = False
        balance = int(api_res.get("balance", 0) or 0)
        free_trials_left = 0

    now = uz_now()

    # Narxni formatlash
    if isinstance(final_price, str):
        display_price = final_price.replace("so`m", "$")
    else:
        display_price = f"${price_value:,.0f}".replace(",", " ")

    text = f"""ğŸ“Š <b>HISOBLASH NATIJASI</b>

ğŸ“± <b>Model:</b> {data['model_name']}
ğŸ’¾ <b>Xotira:</b> {data['storage']}
ğŸ¨ <b>Rang:</b> {color or 'Standart'}
ğŸ“ <b>SIM:</b> {'ğŸ“² eSIM' if data.get('sim_type') == 'esim' else 'ğŸ“± SIM karta'}
ğŸ”‹ <b>Batareya:</b> {data['battery']}
ğŸ“¦ <b>Quti:</b> {'âœ… Bor' if data['has_box'] == 'Bor' else 'âŒ Yo`q'}
ğŸ”§ <b>Holat:</b> {damage_display}

ğŸ’° <b>Narx:</b> <code>{display_price}</code>

{'ğŸ <b>Bepul urinishdan foydalanildi!</b>' if is_free else 'ğŸ’° <b>Pullik balansdan foydalanildi!</b>'}
ğŸ’³ <b>Yangi balans:</b> {balance} ta narxlash
ğŸ <b>Bepul urinishlar qoldi:</b> {free_trials_left} ta

ğŸ•’ <b>Sana:</b> {now}
"""

    from aiogram.types import ReplyKeyboardMarkup, KeyboardButton
    kb = ReplyKeyboardMarkup(resize_keyboard=True)
    kb.row(KeyboardButton("ğŸ”„ Yana hisoblash"), KeyboardButton("ğŸ  Bosh menyu"))

    await call.message.answer(text, reply_markup=kb, parse_mode="HTML")
    await state.finish()


# ================ YAKUNIY NARX - ODDIY MESSAGE DAN ================

async def show_final_price(message: types.Message, state: FSMContext):
    """
    âœ… Yakuniy narx - MESSAGE
    - free_trial bo'lsa LOCAL dan yechadi
    - free tugasa API paid balansdan yechadi
    - Holat Ideal/Yangi bo'lmasa ogohlantirish chiqaradi
    """
    from utils.db_api.user_database import check_can_price, use_pricing as use_pricing_local

    data = await state.get_data()
    selected = data.get('selected_parts', [])
    color = data.get('color') or ""

    if 'sim_type' not in data:
        data['sim_type'] = 'physical'

    # âœ… Damage display (Holat)
    if not selected:
        damage_display = "Yangi"
    else:
        damage_display = data.get('damage_display', " + ".join([PARTS[k] for k in sorted(selected)]))

    # âœ… Narxni hisoblash
    try:
        final_price = calculate_final_price(data)
    except Exception as e:
        logger.error(f"Price calculation error: {e}", exc_info=True)
        final_price = "Hisoblash jarayonida..."

    phone_model = f"{data['model_name']} {data['storage']}"

    # âœ… Narxni raqamga aylantirish
    price_value = 0
    if isinstance(final_price, str):
        price_str = (
            final_price.replace(" $", "")
            .replace("$", "")
            .replace(" ", "")
            .replace(",", "")
        )
        try:
            price_value = int(float(price_str))
        except:
            price_value = 0
    elif isinstance(final_price, (int, float)):
        price_value = int(final_price)

    user_id = message.from_user.id

    local_check = check_can_price(user_id)
    free_trials_left = int(local_check.get("free_trials_left", 0) or 0)

    is_free = False
    balance = 0

    # âœ… 1) Free trial bo'lsa -> LOCAL dan yechamiz
    if free_trials_left > 0:
        local_res = use_pricing_local(
            telegram_id=user_id,
            phone_model=phone_model,
            storage=data.get('storage', ''),
            color=color,
            battery=data.get('battery', '100%'),
            sim_type=data.get('sim_type', 'physical'),
            has_box=data.get('has_box', "Yo'q"),
            damage=damage_display,
            price=price_value
        )

        if not local_res.get("success"):
            await message.answer(
                f"âŒ {local_res.get('error', 'Xatolik')}",
                reply_markup=main_menu(user_id in ADMINS)
            )
            await state.finish()
            return

        is_free = True
        free_trials_left = int(local_res.get("free_trials_left", 0) or 0)

        # API balansni ko'rsatish uchun (ixtiyoriy)
        try:
            api_res = await api.get_balance(user_id)
            balance = int(api_res.get("balance", 0) or 0)
        except Exception as e:
            logger.error(f"API balance get error: {e}")
            balance = 0

    # âœ… 2) Free tugasa -> API paid balansdan yechamiz
    else:
        try:
            api_res = await api.use_pricing(
                telegram_id=user_id,
                phone_model=phone_model,
                price=price_value
            )
        except Exception as e:
            logger.error(f"API use_pricing error: {e}", exc_info=True)
            await message.answer(
                "âŒ Server bilan bog'lanishda xatolik (API). Keyinroq urinib ko'ring.",
                reply_markup=main_menu(user_id in ADMINS)
            )
            await state.finish()
            return

        if not api_res.get("success"):
            await message.answer(
                f"âŒ {api_res.get('error', 'Balans yetarli emas')}",
                reply_markup=main_menu(user_id in ADMINS)
            )
            await state.finish()
            return

        is_free = False
        balance = int(api_res.get("balance", 0) or 0)
        free_trials_left = 0

    now = uz_now()

    # âœ… Narxni formatlash
    if isinstance(final_price, str):
        display_price = final_price
    else:
        display_price = f"${price_value:,.0f}".replace(",", " ")

    # âœ… Ogohlantirish: faqat Ideal/Yangi bo'lmasa
    warning_text = ""
    holat = (damage_display or "").strip().lower()
    if holat not in ("yangi", "ideal"):
        warning_text = (
            "\n\nâš ï¸ <b>Ogohlantirish:</b>\n"
            "Vaqtincha <b>almashgan qismlari bor</b> telefonlarni <b>olmayapmiz</b>."
        )

    text = f"""ğŸ“Š <b>HISOBLASH NATIJASI</b>

ğŸ“± <b>Model:</b> {data['model_name']}
ğŸ’¾ <b>Xotira:</b> {data['storage']}
ğŸ¨ <b>Rang:</b> {color or 'Standart'}
ğŸ“ <b>SIM:</b> {'ğŸ“² eSIM' if data.get('sim_type') == 'esim' else 'ğŸ“± SIM karta'}
ğŸ”‹ <b>Batareya:</b> {data['battery']}
ğŸ“¦ <b>Quti:</b> {'âœ… Bor' if data.get('has_box') == 'Bor' else 'âŒ Yo`q'}
ğŸ”§ <b>Holat:</b> {damage_display}

ğŸ’° <b>Narx:</b> <code>{display_price}</code>

{'ğŸ <b>Bepul urinishdan foydalanildi!</b>' if is_free else 'ğŸ’° <b>Pullik balansdan foydalanildi!</b>'}
ğŸ’³ <b>Yangi balans:</b> {balance} ta narxlash
ğŸ <b>Bepul urinishlar qoldi:</b> {free_trials_left} ta

ğŸ•’ <b>Sana:</b> {now}{warning_text}
"""

    from aiogram.types import ReplyKeyboardMarkup, KeyboardButton
    kb = ReplyKeyboardMarkup(resize_keyboard=True)
    kb.row(KeyboardButton("ğŸ”„ Yana hisoblash"), KeyboardButton("ğŸ  Bosh menyu"))

    await message.answer(text, reply_markup=kb, parse_mode="HTML")
    await state.finish()



# ================ BIZ HAQIMIZDA ================

@dp.message_handler(lambda m: m.text == "â„¹ï¸ Biz haqimizda", state='*')
async def about_handler(message: types.Message, state: FSMContext):
    """Biz haqimizda - Typing effect bilan"""
    await state.finish()

    await typewriter_two_speed_plain_then_html(
        message,
        ABOUT_TEXT,
        fast_delay=0.01,
        slow_delay=0.05,
        fast_chunk=18,
        slow_chunk=10,
    )


@dp.message_handler(lambda m: m.text == "ğŸ”„ Yana hisoblash", state='*')
async def again(message: types.Message, state: FSMContext):
    """Yana hisoblash"""
    await choose_model(message, state)


# ================ NOMA'LUM XABARLAR ================

# @dp.message_handler(state='*')
# async def unknown_message(message: types.Message):
#     """Noma'lum xabarlarga javob"""
#     await message.answer(
#         "ğŸ¤– Iltimos, menyudan birini tanlang yoki /start ni bosing.",
#         reply_markup=main_menu(message.from_user.id in ADMINS)
#     )