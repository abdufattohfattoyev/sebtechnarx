import os
import re
import asyncio
import traceback
from datetime import datetime
import pandas as pd
from aiogram import types
from aiogram.dispatcher import FSMContext
from aiogram.dispatcher.filters.state import State, StatesGroup
from aiogram.types import InputFile
from aiogram.utils.exceptions import RetryAfter

from loader import dp, bot
from keyboards.default.knopkalar import admin_kb, cleanup_confirm_kb
from data.config import ADMINS

# ============================================
# POSTGRESQL IMPORT
# ============================================
from utils.db_api.database import (
    get_models, get_model, add_model,
    get_storages, add_storage,
    get_colors, add_color,
    get_batteries, add_battery,
    get_sim_types, add_sim_type,
    add_part,
    add_price_record,
    clear_all_prices,
    get_total_prices_count,
    normalize_damage_format,
    get_conn
)

# ============================================
# KONSTANTALAR (OPTIMIZED)
# ============================================
MAX_FILE_SIZE_MB = 50
BATCH_SIZE = 10000  # Katta batch = kamroq database query
PROGRESS_UPDATE_INTERVAL = 2000  # Kamroq yangilanish = tezroq ishlash


# ============================================
# STATE'LAR
# ============================================
class ImportState(StatesGroup):
    waiting_file = State()


class CleanupState(StatesGroup):
    confirm = State()


# ============================================
# YORDAMCHI FUNKSIYALAR
# ============================================

async def safe_edit_message(progress_msg, text, parse_mode="HTML"):
    """Xabarni xavfsiz tahrirlash"""
    try:
        await progress_msg.edit_text(text, parse_mode=parse_mode)
    except RetryAfter as e:
        await asyncio.sleep(e.timeout)
        await progress_msg.edit_text(text, parse_mode=parse_mode)
    except Exception:
        pass


def get_cell_value(row, col_name, default=''):
    """Excel katak qiymatini olish"""
    try:
        val = row[col_name]
        if pd.isna(val):
            return str(default)
        return str(val).strip()
    except:
        return str(default)


def detect_columns(df_columns):
    """Ustunlarni avtomatik aniqlash"""
    mapping = {
        'model': None,
        'storage': None,
        'color': None,
        'sim': None,
        'battery': None,
        'box': None,
        'damage': None,
        'price': None
    }

    # Model
    for col in df_columns:
        col_lower = col.lower()
        if 'model' in col_lower or '—Ç–µ–ª–µ—Ñ–æ–Ω' in col_lower:
            mapping['model'] = col
            break

    # Storage
    for col in df_columns:
        col_lower = col.lower()
        if 'xotira' in col_lower or 'storage' in col_lower or '–ø–∞–º—è—Ç—å' in col_lower or 'gb' in col_lower:
            mapping['storage'] = col
            break

    # Color
    for col in df_columns:
        col_lower = col.lower()
        if 'rang' in col_lower or 'color' in col_lower or '—Ü–≤–µ—Ç' in col_lower:
            mapping['color'] = col
            break

    # SIM
    for col in df_columns:
        col_lower = col.lower()
        if 'sim' in col_lower:
            mapping['sim'] = col
            break

    # Battery
    for col in df_columns:
        col_lower = col.lower()
        if 'batar' in col_lower or 'battery' in col_lower or '–±–∞—Ç–∞—Ä–µ—è' in col_lower or 'akkum' in col_lower:
            mapping['battery'] = col
            break

    # Box
    for col in df_columns:
        col_lower = col.lower()
        if 'quti' in col_lower or 'box' in col_lower or '–∫–æ—Ä–æ–±–∫–∞' in col_lower:
            mapping['box'] = col
            break

    # Damage
    for col in df_columns:
        col_lower = col.lower()
        if 'qism' in col_lower or 'damage' in col_lower or '–ø–æ–≤—Ä–µ–∂' in col_lower or '—á–∞—Å—Ç' in col_lower:
            mapping['damage'] = col
            break

    # Price
    for col in df_columns:
        col_lower = col.lower()
        if 'narx' in col_lower or 'price' in col_lower or '—Ü–µ–Ω–∞' in col_lower or '—Å—É–º' in col_lower or 'usd' in col_lower:
            mapping['price'] = col
            break

    return mapping


# ============================================
# BULK INSERT FUNKSIYASI (TEZKOR) - TO'G'RILANDI
# ============================================

def bulk_insert_prices(prices_batch):
    """
    Bir nechta narxlarni bir vaqtning o'zida qo'shish
    PostgreSQL COPY yoki VALUES bilan - 10x tezroq!
    """
    if not prices_batch:
        return 0

    try:
        conn = get_conn()
        cursor = conn.cursor()

        # VALUES qismini tayyorlash (to'g'ri ustun nomlari bilan)
        values_list = []
        for item in prices_batch:
            values_list.append(
                f"({item['model_id']}, "
                f"'{item['storage_size']}', "
                f"'{item['color_name']}', "
                f"'{item['sim_type']}', "
                f"'{item['battery_label']}', "
                f"{item['has_box']}, "
                f"'{item['damage_pct']}', "
                f"{item['price']}, "
                f"CURRENT_TIMESTAMP, "
                f"CURRENT_TIMESTAMP)"
            )

        values_str = ','.join(values_list)

        # Bir SQL bilan hamm–∞—Åini qo'shish (to'g'ri ustun nomlari)
        query = f"""
            INSERT INTO prices 
            (model_id, storage_size, color_name, sim_type, battery_label, 
             has_box, damage_pct, price, created_at, updated_at)
            VALUES {values_str}
            ON CONFLICT (model_id, storage_size, color_name, sim_type, battery_label, has_box, damage_pct)
            DO UPDATE SET 
                price = EXCLUDED.price,
                updated_at = EXCLUDED.updated_at
        """

        cursor.execute(query)
        conn.commit()

        inserted = cursor.rowcount
        cursor.close()
        conn.close()

        return inserted

    except Exception as e:
        print(f"Bulk insert error: {e}")
        return 0


# ============================================
# IMPORT BOSHLASH
# ============================================

@dp.message_handler(lambda msg: msg.text == "üì• Narxlarni import qilish", user_id=ADMINS)
async def import_prices_start(message: types.Message):
    """Import jarayonini boshlash"""
    await message.answer(
        "üìÑ <b>Excel faylni yuboring</b>\n\n"
        "üìã Fayl formati:\n"
        "‚Ä¢ Model, Xotira, Rang, SIM, Batareya, Quti, Qismlar, Narx\n\n"
        "‚ö†Ô∏è Maksimal hajm: 50MB\n"
        "üöÄ Tezkor yuklash rejimi yoqilgan!",
        parse_mode="HTML"
    )
    await ImportState.waiting_file.set()


# ============================================
# IMPORT JARAYONI (SUPER OPTIMIZED)
# ============================================

@dp.message_handler(content_types=['document'], state=ImportState.waiting_file)
async def process_import(message: types.Message, state: FSMContext):
    """Excel faylni import qilish - SUPER TEZKOR"""

    user_id = message.from_user.id
    if user_id not in ADMINS:
        return

    # ============================================
    # 1. FAYLNI TEKSHIRISH
    # ============================================
    file_name = message.document.file_name
    file_size_mb = message.document.file_size / (1024 * 1024)

    if not file_name.lower().endswith(('.xlsx', '.xls')):
        await message.answer("‚ùå Faqat Excel fayllar (.xlsx, .xls)!")
        return

    if file_size_mb > MAX_FILE_SIZE_MB:
        await message.answer(f"‚ùå Fayl juda katta! Maksimal: {MAX_FILE_SIZE_MB}MB")
        return

    progress_msg = await message.answer(
        f"‚ö° <b>Tezkor yuklash...</b>\n"
        f"üì¶ Hajm: {file_size_mb:.2f}MB",
        parse_mode="HTML"
    )

    file_path = f"temp_{user_id}_{datetime.now().timestamp()}.xlsx"
    start_time = datetime.now()

    try:
        # ============================================
        # 2. FAYLNI YUKLAB OLISH
        # ============================================
        await message.document.download(destination_file=file_path)
        await safe_edit_message(progress_msg, "üìä O'qilmoqda...")

        # ============================================
        # 3. EXCEL NI O'QISH
        # ============================================
        df = pd.read_excel(file_path, dtype=str)
        df.columns = [str(c).strip() for c in df.columns]

        total_rows = len(df)

        if total_rows == 0:
            await message.answer("‚ùå Fayl bo'sh!")
            return

        # ============================================
        # 4. USTUNLARNI ANIQLASH
        # ============================================
        col_map = detect_columns(df.columns)

        if not col_map['model'] or not col_map['price']:
            await message.answer(
                "‚ùå <b>Zarur ustunlar topilmadi!</b>\n\n"
                "Kerakli ustunlar:\n"
                "‚Ä¢ Model (majburiy)\n"
                "‚Ä¢ Narx (majburiy)",
                parse_mode="HTML"
            )
            return

        await safe_edit_message(
            progress_msg,
            f"üîÑ <b>Tayyorlanmoqda...</b>\n"
            f"üìä Qatorlar: {total_rows:,}",
            parse_mode="HTML"
        )

        # ============================================
        # 5. MA'LUMOTLARNI TAYYORLASH (OPTIMIZED)
        # ============================================
        models_to_add = set()
        prices_data = []
        skipped = 0

        # Pandas apply yordamida tezroq ishlash
        for index, row in df.iterrows():
            model_name = get_cell_value(row, col_map['model'])
            if not model_name:
                skipped += 1
                continue

            price_raw = get_cell_value(row, col_map['price'], '0')
            price_clean = re.sub(r'[^\d.]', '', price_raw)
            price = float(price_clean) if price_clean else 0

            if price <= 0:
                skipped += 1
                continue

            models_to_add.add(model_name)

            storage = get_cell_value(row, col_map['storage'], '128GB') if col_map['storage'] else '128GB'
            color = get_cell_value(row, col_map['color'], '') if col_map['color'] else ''

            sim_raw = get_cell_value(row, col_map['sim'], 'physical') if col_map['sim'] else 'physical'
            sim_type = 'esim' if 'esim' in sim_raw.lower() else 'physical'

            battery = get_cell_value(row, col_map['battery'], '100%') if col_map['battery'] else '100%'

            box_raw = get_cell_value(row, col_map['box'], 'Bor') if col_map['box'] else 'Bor'
            has_box = any(x in box_raw.lower() for x in ['bor', 'ha', 'yes', '1'])

            damage_raw = get_cell_value(row, col_map['damage'], 'Yangi') if col_map['damage'] else 'Yangi'
            damage = normalize_damage_format(damage_raw)

            prices_data.append({
                'model': model_name,
                'storage': storage,
                'color': color,
                'sim': sim_type,
                'battery': battery,
                'box': has_box,
                'damage': damage,
                'price': price
            })

        valid_count = len(prices_data)

        if valid_count == 0:
            await message.answer("‚ùå Yaroqli ma'lumotlar topilmadi!")
            return

        # ============================================
        # 6. MODELLAR VA BOG'LIQ JADVALLARNI TO'LDIRISH
        # ============================================
        await safe_edit_message(
            progress_msg,
            f"üì± <b>Modellar va parametrlar qo'shilmoqda...</b>\n"
            f"üìä {len(models_to_add)} ta model",
            parse_mode="HTML"
        )

        # Barcha modellarni bir vaqtda qo'shish
        model_ids = {}

        # Unique parametrlarni yig'ish
        unique_storages = {}  # model_id: set(storages)
        unique_colors = {}  # model_id: set(colors)
        unique_batteries = {}  # model_id: set(batteries)
        unique_sim_types = {}  # model_id: set(sim_types)

        try:
            conn = get_conn()
            cursor = conn.cursor()

            # 1. Modellarni qo'shish
            for model_name in models_to_add:
                cursor.execute(
                    "INSERT INTO models (name) VALUES (%s) ON CONFLICT (name) DO NOTHING RETURNING id",
                    (model_name,)
                )
                result = cursor.fetchone()
                if result:
                    model_ids[model_name] = result[0]
                else:
                    cursor.execute("SELECT id FROM models WHERE name = %s", (model_name,))
                    model_ids[model_name] = cursor.fetchone()[0]

            conn.commit()

            # 2. Har bir model uchun parametrlarni yig'ish
            for item in prices_data:
                model_name = item['model']
                model_id = model_ids.get(model_name)

                if not model_id:
                    continue

                # Storages
                if model_id not in unique_storages:
                    unique_storages[model_id] = set()
                unique_storages[model_id].add(item['storage'])

                # Colors
                if model_id not in unique_colors:
                    unique_colors[model_id] = set()
                if item['color']:
                    unique_colors[model_id].add(item['color'])

                # Batteries
                if model_id not in unique_batteries:
                    unique_batteries[model_id] = set()
                unique_batteries[model_id].add(item['battery'])

                # SIM types
                if model_id not in unique_sim_types:
                    unique_sim_types[model_id] = set()
                unique_sim_types[model_id].add(item['sim'])

            # 3. Storages qo'shish
            for model_id, storages in unique_storages.items():
                for storage in storages:
                    cursor.execute(
                        "INSERT INTO storages (model_id, size) VALUES (%s, %s) ON CONFLICT DO NOTHING",
                        (model_id, storage)
                    )

            # 4. Colors qo'shish
            for model_id, colors in unique_colors.items():
                for color in colors:
                    cursor.execute(
                        "INSERT INTO colors (model_id, name) VALUES (%s, %s) ON CONFLICT DO NOTHING",
                        (model_id, color)
                    )

            # 5. Batteries qo'shish
            for model_id, batteries in unique_batteries.items():
                for battery in batteries:
                    cursor.execute(
                        "INSERT INTO batteries (model_id, label) VALUES (%s, %s) ON CONFLICT DO NOTHING",
                        (model_id, battery)
                    )

            # 6. SIM types qo'shish
            for model_id, sim_types in unique_sim_types.items():
                for sim_type in sim_types:
                    cursor.execute(
                        "INSERT INTO sim_types (model_id, type) VALUES (%s, %s) ON CONFLICT DO NOTHING",
                        (model_id, sim_type)
                    )

            conn.commit()
            cursor.close()
            conn.close()

        except Exception as e:
            print(f"Models/params bulk insert error: {e}")
            conn.rollback()

        # ============================================
        # 7. NARXLARNI BULK INSERT (SUPER TEZKOR!)
        # ============================================
        await safe_edit_message(
            progress_msg,
            f"üíæ <b>Narxlar yuklanmoqda...</b>\n"
            f"‚ö° Tezkor rejim\n"
            f"üìä {valid_count:,} ta",
            parse_mode="HTML"
        )

        success_count = 0
        error_count = 0
        last_update_time = datetime.now()

        # Ma'lumotlarni bulk insert uchun tayyorlash (to'g'ri ustun nomlari bilan)
        bulk_batch = []

        for i, item in enumerate(prices_data):
            model_id = model_ids.get(item['model'])
            if not model_id:
                error_count += 1
                continue

            # Damage ni normallashtirish
            damage_normalized = item['damage']
            if not damage_normalized or damage_normalized.lower() in ['yangi', 'nan', 'none']:
                damage_normalized = "Yangi"
            else:
                damage_normalized = normalize_damage_format(damage_normalized)

            bulk_batch.append({
                'model_id': model_id,
                'storage_size': item['storage'].replace("'", "''"),  # SQL injection himoya
                'color_name': item['color'].replace("'", "''"),
                'sim_type': item['sim'],
                'battery_label': item['battery'].replace("'", "''"),
                'has_box': 'TRUE' if item['box'] else 'FALSE',  # PostgreSQL boolean
                'damage_pct': damage_normalized.replace("'", "''"),
                'price': item['price']
            })

            # Batch to'lganda yoki oxirgi element bo'lsa yuklash
            if len(bulk_batch) >= BATCH_SIZE or i == len(prices_data) - 1:
                # DUBLIKATLARNI TOZALASH (kalit bo'yicha)
                unique_batch = []
                seen_keys = set()

                for item in bulk_batch:
                    # Unique kalit yaratish
                    key = (
                        item['model_id'],
                        item['storage_size'],
                        item['color_name'],
                        item['sim_type'],
                        item['battery_label'],
                        item['has_box'],
                        item['damage_pct']
                    )

                    # Agar bu kalit ilgari ko'rilmagan bo'lsa
                    if key not in seen_keys:
                        seen_keys.add(key)
                        unique_batch.append(item)

                # Faqat unique yozuvlarni yuklash
                if unique_batch:
                    inserted = bulk_insert_prices(unique_batch)
                    success_count += inserted

                # Progress yangilash (kamroq tez-tez)
                now = datetime.now()
                if (i % PROGRESS_UPDATE_INTERVAL == 0) or i == len(prices_data) - 1:
                    elapsed = (now - start_time).total_seconds()
                    speed = success_count / elapsed if elapsed > 0 else 0
                    remaining = (valid_count - i) / speed if speed > 0 else 0

                    progress_percent = ((i + 1) / valid_count) * 100
                    progress_bar = "‚ñà" * int(progress_percent / 5) + "‚ñë" * (20 - int(progress_percent / 5))

                    await safe_edit_message(
                        progress_msg,
                        f"üíæ <b>Yuklanmoqda...</b>\n\n"
                        f"[{progress_bar}] {progress_percent:.1f}%\n\n"
                        f"‚úÖ <b>{success_count:,}</b> / {valid_count:,}\n"
                        f"‚ö° {speed:.0f} ta/sek\n"
                        f"üïê ~{int(remaining)}s",
                        parse_mode="HTML"
                    )
                    last_update_time = now

                bulk_batch = []  # Batch ni tozalash

        # ============================================
        # 8. YAKUNIY NATIJA
        # ============================================
        total_time = (datetime.now() - start_time).total_seconds()
        total_prices = get_total_prices_count()

        await message.answer(
            f"‚úÖ <b>Import yakunlandi!</b>\n\n"
            f"üìä <b>Natijalar:</b>\n"
            f"‚Ä¢ Jami qatorlar: {total_rows:,}\n"
            f"‚Ä¢ O'tkazilgan: {skipped:,}\n"
            f"‚Ä¢ Yuklandi: <b>{success_count:,}</b>\n"
            f"‚Ä¢ Xatolar: {error_count:,}\n\n"
            f"üíæ <b>Bazada jami:</b> {total_prices:,}\n"
            f"‚è± <b>Vaqt:</b> {int(total_time)}s ({total_time / 60:.1f} min)\n"
            f"‚ö° <b>Tezlik:</b> {success_count / total_time:.0f} ta/sek",
            parse_mode="HTML",
            reply_markup=admin_kb()
        )

        await progress_msg.delete()

    except Exception as e:
        await message.answer(
            f"‚ùå <b>Xatolik:</b>\n\n"
            f"<code>{str(e)}</code>",
            parse_mode="HTML"
        )
        traceback.print_exc()

    finally:
        if os.path.exists(file_path):
            os.remove(file_path)

        await state.finish()


# ============================================
# TOZALASH
# ============================================

@dp.message_handler(lambda msg: msg.text == "üóë Narxlarni tozalash", user_id=ADMINS)
async def cleanup_prices_start(message: types.Message):
    """Narxlarni tozalashni boshlash"""
    total = get_total_prices_count()

    await message.answer(
        f"‚ö†Ô∏è <b>Diqqat!</b>\n\n"
        f"Bazadagi <b>{total:,} ta narx</b> o'chiriladi!\n\n"
        f"Bu amalni qaytarib bo'lmaydi. Davom etasizmi?",
        parse_mode="HTML",
        reply_markup=cleanup_confirm_kb()
    )

    await CleanupState.confirm.set()


@dp.message_handler(state=CleanupState.confirm)
async def cleanup_confirm(message: types.Message, state: FSMContext):
    """Tozalashni tasdiqlash"""

    if message.text == "‚úÖ Ha, tozalash":
        progress_msg = await message.answer("üîÑ Tozalanmoqda...")

        try:
            if clear_all_prices():
                await progress_msg.edit_text(
                    "‚úÖ <b>Barcha narxlar tozalandi!</b>",
                    parse_mode="HTML"
                )
            else:
                await progress_msg.edit_text("‚ùå Tozalashda xatolik!")
        except Exception as e:
            await progress_msg.edit_text(f"‚ùå Xato: {e}")

        await message.answer("Asosiy menu", reply_markup=admin_kb())
    else:
        await message.answer("Bekor qilindi.", reply_markup=admin_kb())

    await state.finish()


# ============================================
# STATISTIKA
# ============================================

@dp.message_handler(lambda msg: msg.text == "üìä Statistika", user_id=ADMINS)
async def show_statistics(message: types.Message):
    """Bazaning statistikasini ko'rsatish"""

    try:
        total_prices = get_total_prices_count()
        models = get_models()
        total_models = len(models)

        conn = get_conn()
        cursor = conn.cursor()
        cursor.execute("""
            SELECT pg_size_pretty(pg_database_size(current_database()))
        """)
        db_size = cursor.fetchone()[0]

        cursor.execute("""
            SELECT 
                schemaname,
                tablename,
                pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
            FROM pg_tables 
            WHERE schemaname = 'public'
            ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC
            LIMIT 5
        """)
        top_tables = cursor.fetchall()

        cursor.close()
        conn.close()

        text = (
            f"üìä <b>DATABASE STATISTIKASI</b>\n\n"
            f"üóÑÔ∏è <b>Database:</b> PostgreSQL\n"
            f"üíæ <b>Hajm:</b> {db_size}\n\n"
            f"üì± <b>Modellar:</b> {total_models}\n"
            f"üí∞ <b>Narxlar:</b> {total_prices:,}\n\n"
            f"<b>Top 5 jadvallar:</b>\n"
        )

        for schema, table, size in top_tables:
            text += f"  ‚Ä¢ {table}: {size}\n"

        await message.answer(text, parse_mode="HTML")

    except Exception as e:
        await message.answer(f"‚ùå Statistika olishda xato: {e}")


# ============================================
# BEKOR QILISH
# ============================================

@dp.message_handler(state="*", commands=['cancel'])
@dp.message_handler(lambda msg: msg.text.lower() == 'bekor qilish', state="*")
async def cancel_handler(message: types.Message, state: FSMContext):
    """Har qanday jarayonni bekor qilish"""
    current_state = await state.get_state()

    if current_state is None:
        return

    await state.finish()
    await message.answer("Bekor qilindi.", reply_markup=admin_kb())