# app.py - PostgreSQL VERSION
import logging
import asyncio
from aiogram import executor
from aiogram.utils.exceptions import TelegramAPIError, NetworkError

from loader import dp, bot
import middlewares, filters, handlers
from data.config import ADMINS

# ============================================
# LOGGING KONFIGURATSIYASI
# ============================================
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    handlers=[
        logging.FileHandler("bot.log", encoding='utf-8'),
        logging.StreamHandler()
    ]
)

logger = logging.getLogger(__name__)


async def on_startup(dispatcher):
    """Bot ishga tushganda"""

    logger.info("=" * 60)
    logger.info("üöÄ BOT ISHGA TUSHMOQDA...")
    logger.info("=" * 60)

    # ============================================
    # 1. POSTGRESQL PHONES DATABASE
    # ============================================
    try:
        from utils.db_api.database_postgres import init_db, test_connection

        # Avval ulanishni tekshirish
        logger.info("üîÑ PostgreSQL ga ulanish tekshirilmoqda...")
        if test_connection():
            logger.info("‚úÖ PostgreSQL ulanishi muvaffaqiyatli!")

            # Database yaratish
            logger.info("üîÑ Database strukturasi tekshirilmoqda...")
            init_db()
            logger.info("‚úÖ phones_db tayyor!")
        else:
            logger.error("‚ùå PostgreSQL ga ulanib bo'lmadi!")
            logger.error("‚ö†Ô∏è .env faylni tekshiring!")
            raise Exception("PostgreSQL connection failed")

    except ImportError as e:
        logger.error(f"‚ùå database_postgres.py topilmadi: {e}")
        logger.error("üìÅ utils/db_api/ papkasida database_postgres.py borligini tekshiring")
        raise
    except Exception as e:
        logger.error(f"‚ùå phones_db xato: {e}")
        logger.error("üí° PostgreSQL ishlab turganini tekshiring:")
        logger.error("   sudo systemctl status postgresql")
        raise

    # ============================================
    # 2. USER STATISTICS DATABASE (ixtiyoriy)
    # ============================================
    try:
        from utils.db_api.user_database import init_user_db
        init_user_db()
        logger.info("‚úÖ stats.db yaratildi!")
    except ImportError:
        logger.warning("‚ö†Ô∏è user_database.py topilmadi, statistika o'chirilgan")
    except Exception as e:
        logger.warning(f"‚ö†Ô∏è stats.db xato (kritik emas): {e}")

    # ============================================
    # 3. ADMINLARGA XABAR YUBORISH
    # ============================================
    logger.info("üì® Adminlarga xabar yuborilmoqda...")
    success_count = 0

    for admin_id in ADMINS:
        try:
            await asyncio.wait_for(
                bot.send_message(
                    admin_id,
                    "ü§ñ <b>Bot ishga tushdi!</b>\n\n"
                    "üóÑÔ∏è Database: PostgreSQL\n"
                    "üìä Status: Tayyor",
                    parse_mode="HTML"
                ),
                timeout=10
            )
            success_count += 1
            logger.info(f"‚úÖ Admin {admin_id} ga xabar yuborildi")
        except asyncio.TimeoutError:
            logger.warning(f"‚ö†Ô∏è Admin {admin_id} ga xabar yuborish timeout")
        except (TelegramAPIError, NetworkError) as e:
            logger.warning(f"‚ö†Ô∏è Admin {admin_id} ga ulanib bo'lmadi: {e}")
        except Exception as e:
            logger.error(f"‚ùå Admin {admin_id} ga xabar yuborishda xato: {e}")

    logger.info(f"üì® {success_count}/{len(ADMINS)} ta adminga xabar yuborildi")

    # ============================================
    # 4. YAKUNIY XABAR
    # ============================================
    logger.info("=" * 60)
    logger.info("‚úÖ BOT MUVAFFAQIYATLI ISHGA TUSHDI!")
    logger.info("üóÑÔ∏è  Database: PostgreSQL")
    logger.info("üìä Polling: Faol")
    logger.info("=" * 60)


async def on_shutdown(dispatcher):
    """Bot to'xtaganda"""

    logger.warning("=" * 60)
    logger.warning("‚õî BOT TO'XTATILMOQDA...")
    logger.warning("=" * 60)

    # ============================================
    # 1. ADMINLARGA XABAR
    # ============================================
    for admin_id in ADMINS:
        try:
            await asyncio.wait_for(
                bot.send_message(
                    admin_id,
                    "‚õî <b>Bot to'xtatildi!</b>",
                    parse_mode="HTML"
                ),
                timeout=5
            )
        except:
            pass

    # ============================================
    # 2. CONNECTION'LARNI YOPISH
    # ============================================
    logger.info("üîÑ Connection'lar yopilmoqda...")

    try:
        await bot.close()
        logger.info("‚úÖ Bot connection yopildi")
    except Exception as e:
        logger.error(f"‚ùå Bot connection yopishda xato: {e}")

    # PostgreSQL connection'larni yopish kerak emas
    # Chunki har bir funksiya o'z connection'ini ochadi va yopadi

    logger.warning("=" * 60)
    logger.warning("‚úÖ BOT TO'LIQ TO'XTATILDI!")
    logger.warning("=" * 60)


def main():
    """Bot ishga tushirish"""
    try:
        logger.info("üöÄ Executor ishga tushmoqda...")

        executor.start_polling(
            dp,
            on_startup=on_startup,
            on_shutdown=on_shutdown,
            skip_updates=True,  # Eski xabarlarni o'tkazib yuborish
            timeout=60,  # Polling timeout
            relax=0.1,  # Requestlar orasida pauza
            fast=False  # Fast mode o'chirish (barqarorlik uchun)
        )

    except (KeyboardInterrupt, SystemExit):
        logger.info("‚úã Bot to'xtatildi (Ctrl+C)")

    except Exception as e:
        logger.critical("=" * 60)
        logger.critical(f"üí• KRITIK XATO: {e}")
        logger.critical("=" * 60)

        # Xatolik tafsilotlarini yozish
        import traceback
        logger.critical(traceback.format_exc())

        raise


if __name__ == '__main__':
    main()