# app.py
import logging
import asyncio
from aiogram import executor
from aiogram.utils.exceptions import TelegramAPIError, NetworkError

from loader import dp, bot
import middlewares, filters, handlers
from data.config import ADMINS

logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s"
)


async def on_startup(dispatcher):
    """Bot ishga tushganda"""

    # Database yaratish
    try:
        from utils.db_api.database import init_db
        init_db()
        logging.info("‚úÖ phones.db yaratildi yoki ulandi")
    except Exception as e:
        logging.error(f"‚ùå phones.db xato: {e}")

    try:
        from utils.db_api.user_database import init_stats_tables
        init_stats_tables()
        logging.info("‚úÖ stats.db yaratildi!")
    except Exception as e:
        logging.error(f"‚ùå stats.db xato: {e}")

    # Adminlarga xabar - XATO BILAN KURASHISH
    for admin_id in ADMINS:
        try:
            await asyncio.wait_for(
                bot.send_message(admin_id, "ü§ñ Bot ishga tushdi!"),
                timeout=10  # 10 soniya timeout
            )
        except asyncio.TimeoutError:
            logging.warning(f"‚ö†Ô∏è Admin {admin_id} ga xabar yuborish timeout")
        except (TelegramAPIError, NetworkError) as e:
            logging.warning(f"‚ö†Ô∏è Admin {admin_id} ga xabar yuborib bo'lmadi: {e}")
        except Exception as e:
            logging.error(f"‚ùå Noma'lum xato: {e}")

    logging.info("üöÄ Bot muvaffaqiyatli ishga tushdi!")


async def on_shutdown(dispatcher):
    """Bot to'xtaganda"""

    # Adminlarga xabar
    for admin_id in ADMINS:
        try:
            await bot.send_message(admin_id, "‚õî Bot to'xtatildi!")
        except:
            pass

    logging.warning("‚õî Bot to'xtatildi!")

    # Connection'larni yopish
    await bot.close()


if __name__ == '__main__':
    # ‚úÖ YANGI: Exception handling bilan polling
    try:
        executor.start_polling(
            dp,
            on_startup=on_startup,
            on_shutdown=on_shutdown,
            skip_updates=True,
            timeout=60,  # Polling timeout
            relax=0.1,  # Requestlar orasida pauza
            fast=False  # Fast mode o'chirish
        )
    except (KeyboardInterrupt, SystemExit):
        logging.info("‚úã Bot to'xtatildi (Ctrl+C)")
    except Exception as e:
        logging.critical(f"üí• KRITIK XATO: {e}")
        raise